<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Nutrition Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* GLASS & NEON THEME */
        body {
            margin: 0; padding: 16px; font-family: 'Segoe UI', sans-serif;
            background-color: #0f0f13; color: #fff;
            min-height: 100vh; display: flex; flex-direction: column; gap: 15px;
        }
        .background-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(70px); opacity: 0.5; animation: move 10s infinite alternate; }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #7b2cbf; }
        .blob-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: #3a0ca3; }

        @keyframes move { from { transform: translate(0,0); } to { transform: translate(20px, -20px); } }

        .glass-card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 20px;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .btn-icon { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 18px; }
        select { background: rgba(0,0,0,0.3); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 5px; border-radius: 8px; outline: none; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .main-stats { text-align: center; margin-bottom: 15px; }
        .cals-big { font-size: 32px; font-weight: 800; background: linear-gradient(90deg, #f72585, #4cc9f0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cals-sub { font-size: 14px; color: rgba(255,255,255,0.6); }

        /* –ú–∞–∫—Ä–æ—Å—ã (–ë–ñ–£) */
        .macros-grid { display: flex; gap: 10px; margin-top: 10px; }
        .macro-item { flex: 1; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; font-size: 12px; text-align: center; }
        .macro-val { font-weight: bold; font-size: 14px; display: block; }
        .macro-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 5px; }
        .macro-bar-fill { height: 100%; border-radius: 2px; width: 0%; transition: width 0.5s; }
        
        .p-color { color: #4cc9f0; } .p-bg { background: #4cc9f0; } /* –ë–µ–ª–∫–∏ */
        .f-color { color: #f72585; } .f-bg { background: #f72585; } /* –ñ–∏—Ä—ã */
        .c-color { color: #fee440; } .c-bg { background: #fee440; } /* –£–≥–ª–µ–≤–æ–¥—ã */

        /* –í–≤–æ–¥ */
        textarea { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 15px; border-radius: 15px; resize: none; outline: none; box-sizing: border-box; }
        .actions-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-send { flex: 1; background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white; border: none; border-radius: 12px; height: 50px; font-weight: bold; font-size: 16px; }
        .btn-photo { width: 50px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        #fileInput { display: none; }
        #previewContainer { display: none; margin-bottom: 10px; }
        #previewImage { width: 100%; border-radius: 10px; }

        /* –ú–æ–¥–∞–ª–∫–∞ –ü—Ä–æ—Ñ–∏–ª—è */
        #profileModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #1a1a20; padding: 20px; border-radius: 20px; width: 80%; border: 1px solid rgba(255,255,255,0.1); }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 12px; margin-bottom: 5px; color: #aaa; }
        .form-control { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box;}
        .btn-save { width: 100%; background: #4cc9f0; color: #000; padding: 10px; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; }

        /* –°–ø–∏—Å–æ–∫ –µ–¥—ã */
        .food-list { list-style: none; padding: 0; margin: 0; }
        .food-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .food-desc { font-size: 12px; color: #888; margin-top: 2px; }
    </style>
</head>
<body>
    <div class="background-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="top-bar">
        <button class="btn-icon" onclick="openProfile()">‚öôÔ∏è</button>
        <select id="langSelect" onchange="changeLanguage()">
            <option value="ru">RU</option> <option value="uz">UZ</option> <option value="en">EN</option>
        </select>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="glass-card">
        <div class="main-stats">
            <div class="cals-big"><span id="currCals">0</span> / <span id="targetCals">2000</span></div>
            <div class="cals-sub" id="txtKcal">–∫–∫–∞–ª —Å–µ–≥–æ–¥–Ω—è</div>
        </div>

        <!-- –ë–ñ–£ –ë–∞—Ä—ã -->
        <div class="macros-grid">
            <div class="macro-item">
                <span class="p-color">Protein</span>
                <span class="macro-val"><span id="currP">0</span>/<span id="targetP">150</span></span>
                <div class="macro-bar-bg"><div class="macro-bar-fill p-bg" id="barP"></div></div>
            </div>
            <div class="macro-item">
                <span class="f-color">Fat</span>
                <span class="macro-val"><span id="currF">0</span>/<span id="targetF">70</span></span>
                <div class="macro-bar-bg"><div class="macro-bar-fill f-bg" id="barF"></div></div>
            </div>
            <div class="macro-item">
                <span class="c-color">Carbs</span>
                <span class="macro-val"><span id="currC">0</span>/<span id="targetC">200</span></span>
                <div class="macro-bar-bg"><div class="macro-bar-fill c-bg" id="barC"></div></div>
            </div>
        </div>
    </div>

    <!-- –í–≤–æ–¥ -->
    <div class="glass-card">
        <div id="previewContainer"><img id="previewImage"></div>
        <textarea id="foodInput" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?"></textarea>
        <div class="actions-row">
            <label class="btn-photo">üì∑<input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)"></label>
            <button class="btn-send" id="analyzeBtn" onclick="processFood()">–ê–Ω–∞–ª–∏–∑</button>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="glass-card">
        <div style="margin-bottom:10px; font-weight:bold; color:#aaa;">–ò—Å—Ç–æ—Ä–∏—è</div>
        <ul class="food-list" id="foodList"></ul>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ü–†–û–§–ò–õ–Ø -->
    <div id="profileModal">
        <div class="modal-content">
            <h3 style="margin-top:0">–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</h3>
            <div class="form-group"><label>–í–µ—Å (–∫–≥)</label><input type="number" id="pWeight" class="form-control" value="70"></div>
            <div class="form-group"><label>–†–æ—Å—Ç (—Å–º)</label><input type="number" id="pHeight" class="form-control" value="175"></div>
            <div class="form-group"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input type="number" id="pAge" class="form-control" value="25"></div>
            <div class="form-group"><label>–ü–æ–ª</label>
                <select id="pGender" class="form-control"><option value="male">–ú—É–∂—Å–∫–æ–π</option><option value="female">–ñ–µ–Ω—Å–∫–∏–π</option></select>
            </div>
            <div class="form-group"><label>–¶–µ–ª—å</label>
                <select id="pGoal" class="form-control">
                    <option value="lose">–ü–æ—Ö—É–¥–µ—Ç—å</option>
                    <option value="maintain" selected>–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å</option>
                    <option value="gain">–ù–∞–±—Ä–∞—Ç—å</option>
                </select>
            </div>
            <div class="form-group"><label>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                <select id="pActivity" class="form-control">
                    <option value="low">–°–∏–¥—è—á–∞—è</option>
                    <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                    <option value="high">–ê–∫—Ç–∏–≤–Ω–∞—è</option>
                </select>
            </div>
            <button class="btn-save" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <button onclick="document.getElementById('profileModal').style.display='none'" style="width:100%; background:transparent; border:none; color:#aaa; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0f0f13'); 

        // üëá –°–°–´–õ–ö–ê NGROK
        const BASE_URL = " https://deja-embryoid-rosendo.ngrok-free.dev"; 

        const USER_ID = tg.initDataUnsafe?.user?.id || 1; // 1 –¥–ª—è —Ç–µ—Å—Ç–∞
        let currentLang = 'ru';

        // –î–∞–Ω–Ω—ã–µ (–°—É–º–º–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è)
        let stats = { cals: 0, p: 0, f: 0, c: 0 };
        let targets = { cals: 2000, p: 150, f: 70, c: 200 };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadProfile();
        loadHistory();

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Ü–µ–ª–µ–π
        async function loadProfile() {
            try {
                const res = await fetch(`${BASE_URL}/get_profile?user_id=${USER_ID}`, { headers: {"ngrok-skip-browser-warning":"true"} });
                const data = await res.json();
                targets = data;
                updateStatsUI();
            } catch(e) { console.error(e); }
        }

        // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        async function saveProfile() {
            const formData = new FormData();
            formData.append('user_id', USER_ID);
            formData.append('weight', document.getElementById('pWeight').value);
            formData.append('height', document.getElementById('pHeight').value);
            formData.append('age', document.getElementById('pAge').value);
            formData.append('gender', document.getElementById('pGender').value);
            formData.append('goal', document.getElementById('pGoal').value);
            formData.append('activity', document.getElementById('pActivity').value);

            try {
                const res = await fetch(`${BASE_URL}/save_profile`, { method: 'POST', body: formData });
                const data = await res.json();
                targets = data.targets; // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª–∏
                document.getElementById('profileModal').style.display = 'none';
                updateStatsUI();
                tg.showPopup({message: '–ü–ª–∞–Ω –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω!'});
            } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
        }

        // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        async function loadHistory() {
            try {
                const res = await fetch(`${BASE_URL}/get_history?user_id=${USER_ID}`, { headers: {"ngrok-skip-browser-warning":"true"} });
                const history = await res.json();
                
                const list = document.getElementById('foodList');
                list.innerHTML = '';
                stats = { cals: 0, p: 0, f: 0, c: 0 };
                const todayStr = new Date().toISOString().split('T')[0];

                history.forEach(item => {
                    // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                    if(item.date === todayStr) {
                        stats.cals += item.calories;
                        stats.p += (item.p || 0);
                        stats.f += (item.f || 0);
                        stats.c += (item.c || 0);
                    }

                    // –†–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫
                    const li = document.createElement('li');
                    li.className = 'food-item';
                    li.innerHTML = `
                        <div>
                            <div style="font-weight:500;">${item.name}</div>
                            <div class="food-desc">P: ${item.p||0} | F: ${item.f||0} | C: ${item.c||0}</div>
                        </div>
                        <div style="font-weight:bold; color:#4cc9f0;">${item.calories}</div>
                    `;
                    list.appendChild(li);
                });
                updateStatsUI();
            } catch(e) { console.error(e); }
        }

        // 4. UI –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        function updateStatsUI() {
            document.getElementById('currCals').innerText = stats.cals;
            document.getElementById('targetCals').innerText = targets.cals;
            
            document.getElementById('currP').innerText = stats.p;
            document.getElementById('targetP').innerText = targets.p;
            document.getElementById('barP').style.width = Math.min((stats.p / targets.p)*100, 100) + '%';

            document.getElementById('currF').innerText = stats.f;
            document.getElementById('targetF').innerText = targets.f;
            document.getElementById('barF').style.width = Math.min((stats.f / targets.f)*100, 100) + '%';

            document.getElementById('currC').innerText = stats.c;
            document.getElementById('targetC').innerText = targets.c;
            document.getElementById('barC').style.width = Math.min((stats.c / targets.c)*100, 100) + '%';
        }

        // 5. –ê–Ω–∞–ª–∏–∑ –µ–¥—ã
        async function processFood() {
            const textInput = document.getElementById('foodInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            const file = document.getElementById('fileInput').files[0];

            if(!textInput && !file) return;
            btn.disabled = true; btn.innerText = "...";

            const formData = new FormData();
            formData.append('text', textInput);
            formData.append('user_id', USER_ID);
            formData.append('language', document.getElementById('langSelect').value);
            if(file) formData.append('photo', file);

            try {
                const res = await fetch(`${BASE_URL}/analyze`, { method: 'POST', body: formData, headers: {"ngrok-skip-browser-warning":"true"} });
                const data = await res.json();
                if(data.calories > 0) {
                    loadHistory();
                    document.getElementById('foodInput').value = '';
                    document.getElementById('previewContainer').style.display = 'none';
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showPopup({message: '–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ'});
                }
            } catch(e) { alert("Error"); }
            finally { btn.disabled = false; btn.innerText = "–ê–Ω–∞–ª–∏–∑"; }
        }

        function openProfile() { document.getElementById('profileModal').style.display = 'flex'; }
        function handleFileSelect(e) { 
            const f = e.target.files[0]; 
            if(f) { 
                document.getElementById('previewImage').src = URL.createObjectURL(f); 
                document.getElementById('previewContainer').style.display='block'; 
            } 
        }
        function changeLanguage() { /* –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–≤–æ–¥–æ–≤, –∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏ */ }
    </script>
</body>
</html>
