<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calorie AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-theme-bg-color: #fff; --tg-theme-text-color: #000; --tg-theme-button-color: #2481cc; --tg-theme-button-text-color: #fff; --tg-theme-secondary-bg-color: #efeff3; --tg-theme-hint-color: #999; }
        body { background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); font-family: -apple-system, sans-serif; margin: 0; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å —è–∑—ã–∫–æ–º */
        .top-bar { display: flex; justify-content: flex-end; margin-bottom: 5px; }
        select { background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border: none; padding: 5px 10px; border-radius: 8px; font-size: 14px; outline: none; }

        .card { background-color: var(--tg-theme-bg-color); border-radius: 14px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stats-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; }
        .progress-container { width: 100%; background-color: var(--tg-theme-secondary-bg-color); border-radius: 6px; height: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--tg-theme-button-color); width: 0%; transition: width 0.4s ease-out; }
        
        textarea { width: 100%; min-height: 60px; padding: 12px; border: 1px solid transparent; background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); border-radius: 10px; resize: none; outline: none; box-sizing: border-box; }
        
        .actions-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-photo { flex: 0 0 50px; height: 50px; display: flex; align-items: center; justify-content: center; background-color: var(--tg-theme-secondary-bg-color); border-radius: 10px; cursor: pointer; font-size: 24px; }
        #fileInput { display: none; }
        .btn-send { flex: 1; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        #previewContainer { display: none; margin-bottom: 10px; }
        #previewImage { width: 100%; border-radius: 10px; max-height: 200px; object-fit: cover; }
        
        /* –ò—Å—Ç–æ—Ä–∏—è */
        .food-list { list-style: none; padding: 0; margin: 0; }
        .food-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--tg-theme-secondary-bg-color); }
        .food-calories { font-weight: 600; background: var(--tg-theme-secondary-bg-color); padding: 4px 8px; border-radius: 6px; font-size: 13px; }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã */
        .date-header {
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--tg-theme-hint-color);
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
    <div class="top-bar">
        <select id="langSelect" onchange="changeLanguage()">
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            <option value="uz">üá∫üáø O'zbekcha</option>
            <option value="en">üá∫üá∏ English</option>
        </select>
    </div>

    <div class="card">
        <div class="stats-header">
            <span id="txtToday">–°–µ–≥–æ–¥–Ω—è</span>
            <span><span id="currentCals">0</span> / 2000</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <div class="card">
        <div id="previewContainer"><img id="previewImage" src=""></div>
        <textarea id="foodInput" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?"></textarea>
        <div class="actions-row">
            <label class="btn-photo">üì∑<input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)"></label>
            <button class="btn-send" id="analyzeBtn" onclick="processFood()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="card">
        <div class="stats-header" id="txtHistory">–ò—Å—Ç–æ—Ä–∏—è</div>
        <ul class="food-list" id="foodList">
            <li style="text-align:center; color:grey; padding:10px" id="txtEmpty">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
        </ul>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ NGROK üëá
        const BASE_URL = "https://deja-embryoid-rosendo.ngrok-free.dev"; 

        const USER_ID = tg.initDataUnsafe?.user?.id || 0;
        let currentLang = localStorage.getItem('app_lang') || 'ru'; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —è–∑—ã–∫
        document.getElementById('langSelect').value = currentLang;

        // –ü–µ—Ä–µ–≤–æ–¥—ã
        const TRANSLATIONS = {
            'ru': { today: '–°–µ–≥–æ–¥–Ω—è', history: '–ò—Å—Ç–æ—Ä–∏—è', add: '–î–æ–±–∞–≤–∏—Ç—å', think: '–î—É–º–∞—é...', input: '–ß—Ç–æ —Å—ä–µ–ª–∏?', empty: '–ü–æ–∫–∞ –ø—É—Å—Ç–æ', error: '–ù–µ –ø–æ–Ω—è–ª' },
            'uz': { today: 'Bugun', history: 'Tarix', add: "Qo'shish", think: 'O\'ylayapman...', input: 'Nima yediz?', empty: 'Hozircha bo\'sh', error: 'Tushunmadim' },
            'en': { today: 'Today', history: 'History', add: 'Add', think: 'Thinking...', input: 'What did you eat?', empty: 'Empty', error: 'Did not understand' }
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function updateUITexts() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('txtToday').innerText = t.today;
            document.getElementById('txtHistory').innerText = t.history;
            document.getElementById('analyzeBtn').innerText = t.add;
            document.getElementById('foodInput').placeholder = t.input;
            if(document.getElementById('txtEmpty')) document.getElementById('txtEmpty').innerText = t.empty;
        }

        function changeLanguage() {
            currentLang = document.getElementById('langSelect').value;
            localStorage.setItem('app_lang', currentLang);
            updateUITexts();
        }

        let todayCalories = 0;
        const DAILY_GOAL = 2000;
        let selectedFile = null;

        // –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò (–ü–û –î–ù–Ø–ú)
        async function loadHistory() {
            try {
                const res = await fetch(`${BASE_URL}/get_history?user_id=${USER_ID}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const history = await res.json();
                
                const list = document.getElementById('foodList');
                list.innerHTML = '';
                todayCalories = 0;

                if (history.length === 0) {
                    list.innerHTML = `<li id="txtEmpty" style="text-align:center; color:grey; padding:10px">${TRANSLATIONS[currentLang].empty}</li>`;
                    return;
                }

                // –õ–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–∞–º
                let lastDate = null;
                const todayStr = new Date().toISOString().split('T')[0]; // "2025-02-05"

                history.forEach(item => {
                    // –ï—Å–ª–∏ —ç—Ç–æ –µ–¥–∞ –∑–∞ –°–ï–ì–û–î–ù–Ø, –ø–ª—é—Å—É–µ–º –≤ –ø—Ä–æ–≥—Ä–µ—Å—Å
                    if (item.date === todayStr) {
                        todayCalories += item.calories;
                    }

                    // –ï—Å–ª–∏ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, —Ä–∏—Å—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    if (item.date !== lastDate) {
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'date-header';
                        // –ü–∏—à–µ–º "–°–µ–≥–æ–¥–Ω—è" –∏–ª–∏ —Å–∞–º—É –¥–∞—Ç—É
                        dateHeader.innerText = (item.date === todayStr) ? TRANSLATIONS[currentLang].today : item.date;
                        list.appendChild(dateHeader);
                        lastDate = item.date;
                    }

                    // –†–∏—Å—É–µ–º –µ–¥—É
                    const li = document.createElement('li');
                    li.className = 'food-item';
                    li.innerHTML = `<span class="food-name">${item.name}</span><span class="food-calories">${item.calories}</span>`;
                    list.appendChild(li);
                });

                updateStats();
            } catch (e) {
                console.error(e);
            }
        }

        // –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        async function processFood() {
            const textInput = document.getElementById('foodInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            const t = TRANSLATIONS[currentLang];

            if (!textInput && !selectedFile) return;

            btn.disabled = true;
            btn.innerText = t.think;

            const formData = new FormData();
            formData.append('text', textInput);
            formData.append('user_id', USER_ID);
            formData.append('language', currentLang); // üëá –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —è–∑—ã–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (selectedFile) formData.append('photo', selectedFile);

            try {
                const response = await fetch(`${BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { "ngrok-skip-browser-warning": "true" },
                    body: formData
                });
                const data = await response.json();

                if (data.calories > 0) {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤—Å—Ç–∞–ª–∞ –∫—Ä–∞—Å–∏–≤–æ –≤ –¥–∞—Ç—É
                    loadHistory();
                    
                    document.getElementById('foodInput').value = '';
                    selectedFile = null;
                    document.getElementById('previewContainer').style.display = 'none';
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showPopup({message: t.error});
                }
            } catch (error) {
                alert("Server Error");
            } finally {
                btn.disabled = false;
                btn.innerText = t.add;
            }
        }

        function updateStats() {
            document.getElementById('currentCals').innerText = todayCalories;
            let percent = (todayCalories / DAILY_GOAL) * 100;
            if (percent > 100) percent = 100;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // –°—Ç–∞—Ä—Ç
        updateUITexts();
        loadHistory();

    </script>
</body>
</html>
