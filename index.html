<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calorie AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-theme-bg-color: #fff; 
            --tg-theme-text-color: #000; 
            --tg-theme-button-color: #2481cc; 
            --tg-theme-button-text-color: #fff; 
            --tg-theme-secondary-bg-color: #efeff3; 
            --tg-theme-hint-color: #999; 
        }
        body { 
            background-color: var(--tg-theme-secondary-bg-color); 
            color: var(--tg-theme-text-color); 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 70px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é */
        }
        .container { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

        /* –í–∫–ª–∞–¥–∫–∏ (–≠–∫—Ä–∞–Ω—ã) */
        .tab-content { display: none; }
        .tab-content.active { display: flex; flex-direction: column; gap: 12px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { background-color: var(--tg-theme-bg-color); border-radius: 14px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .stats-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; }
        .progress-container { width: 100%; background-color: var(--tg-theme-secondary-bg-color); border-radius: 6px; height: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--tg-theme-button-color); width: 0%; transition: width 0.4s ease-out; }

        /* –í–≤–æ–¥ –µ–¥—ã */
        textarea { width: 100%; min-height: 60px; padding: 12px; border: 1px solid transparent; background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); border-radius: 10px; resize: none; outline: none; box-sizing: border-box; }
        .actions-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-photo { flex: 0 0 50px; height: 50px; display: flex; align-items: center; justify-content: center; background-color: var(--tg-theme-secondary-bg-color); border-radius: 10px; cursor: pointer; font-size: 24px; }
        #fileInput { display: none; }
        .btn-send { flex: 1; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        #previewContainer { display: none; margin-bottom: 10px; }
        #previewImage { width: 100%; border-radius: 10px; max-height: 200px; object-fit: cover; }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .food-list { list-style: none; padding: 0; margin: 0; }
        .food-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--tg-theme-secondary-bg-color); }
        .food-calories { font-weight: 600; background: var(--tg-theme-secondary-bg-color); padding: 4px 8px; border-radius: 6px; font-size: 13px; }
        .date-header { margin-top: 15px; margin-bottom: 5px; font-size: 13px; color: var(--tg-theme-hint-color); font-weight: bold; text-transform: uppercase; }

        /* –ü–†–û–§–ò–õ–¨ */
        .profile-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .profile-input { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid #ccc; text-align: center; }
        .profile-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; flex: 1; margin-left: 10px; }
        .vip-badge { background: gold; color: black; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 12px; display: none; }
        .btn-vip { background-color: #ffcc00; color: #000; width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--tg-theme-bg-color); border-top: 1px solid var(--tg-theme-secondary-bg-color); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .nav-item { color: var(--tg-theme-hint-color); font-size: 12px; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--tg-theme-button-color); font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

    </style>
</head>
<body>

    <!-- –í–∫–ª–∞–¥–∫–∞ 1: –ì–õ–ê–í–ù–ê–Ø -->
    <div id="tab-home" class="container tab-content active">
        <!-- –Ø–∑—ã–∫ -->
        <div style="display:flex; justify-content: flex-end;">
            <select id="langSelect" onchange="changeLanguage()" style="border:none; bg:transparent;">
                <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                <option value="uz">üá∫üáø O'zbekcha</option>
                <option value="en">üá∫üá∏ English</option>
            </select>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card">
            <div class="stats-header">
                <span id="txtToday">–°–µ–≥–æ–¥–Ω—è</span>
                <span><span id="currentCals">0</span> / <span id="targetCals">2000</span></span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <!-- –í–≤–æ–¥ -->
        <div class="card">
            <div id="previewContainer"><img id="previewImage" src=""></div>
            <textarea id="foodInput" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?"></textarea>
            <div class="actions-row">
                <label class="btn-photo">üì∑<input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)"></label>
                <button class="btn-send" id="analyzeBtn" onclick="processFood()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
        <div class="card">
            <div class="stats-header" id="txtHistory">–ò—Å—Ç–æ—Ä–∏—è</div>
            <ul class="food-list" id="foodList">
                <li style="text-align:center; color:grey; padding:10px" id="txtEmpty">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
            </ul>
        </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ 2: –ü–†–û–§–ò–õ–¨ -->
    <div id="tab-profile" class="container tab-content">
        <div class="card">
            <div class="stats-header">
                <span id="txtProfileTitle">–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</span>
                <span id="vipBadge" class="vip-badge">üëë VIP</span>
            </div>

            <div class="profile-row">
                <span id="lblWeight">–í–µ—Å (–∫–≥)</span>
                <input type="number" id="inpWeight" class="profile-input" placeholder="70" onchange="calculateGoal()">
            </div>
            <div class="profile-row">
                <span id="lblHeight">–†–æ—Å—Ç (—Å–º)</span>
                <input type="number" id="inpHeight" class="profile-input" placeholder="175" onchange="calculateGoal()">
            </div>
            <div class="profile-row">
                <span id="lblAge">–í–æ–∑—Ä–∞—Å—Ç</span>
                <input type="number" id="inpAge" class="profile-input" placeholder="25" onchange="calculateGoal()">
            </div>
            <div class="profile-row">
                <span id="lblGender">–ü–æ–ª</span>
                <select id="selGender" class="profile-select" onchange="calculateGoal()">
                    <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
            </div>
            <div class="profile-row">
                <span id="lblGoal">–¶–µ–ª—å</span>
                <select id="selGoal" class="profile-select" onchange="calculateGoal()">
                    <option value="lose">–ü–æ—Ö—É–¥–µ–Ω–∏–µ</option>
                    <option value="maintain">–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ</option>
                    <option value="gain">–ù–∞–±–æ—Ä –≤–µ—Å–∞</option>
                </select>
            </div>
            
            <hr>
            <div style="text-align:center; margin:10px 0;">
                <span id="lblResult">–í–∞—à–∞ –Ω–æ—Ä–º–∞:</span> 
                <strong style="font-size:18px;" id="calcResult">2000</strong> kcal
            </div>
        </div>

        <!-- –ü–æ–∫—É–ø–∫–∞ VIP -->
        <div class="card" id="vipCard">
            <h3 style="margin-top:0;">üåü Premium</h3>
            <p style="font-size:14px; color:grey;" id="txtVipDesc">–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</p>
            <button class="btn-vip" onclick="buyVip()">–ö—É–ø–∏—Ç—å VIP (50 ‚≠êÔ∏è)</button>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω–µ–µ –ú–µ–Ω—é -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')" id="navHome">
            <span class="nav-icon">üè†</span> <span id="lblMenuHome">–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile')" id="navProfile">
            <span class="nav-icon">üë§</span> <span id="lblMenuProfile">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô URL NGROK
        const BASE_URL = "https://deja-embryoid-rosendo.ngrok-free.dev"; 
        
        const USER_ID = tg.initDataUnsafe?.user?.id || 0;

        // –Ø–∑—ã–∫
        let currentLang = localStorage.getItem('app_lang') || 'ru';
        document.getElementById('langSelect').value = currentLang;

        // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ LocalStorage –±—Ä–∞—É–∑–µ—Ä–∞)
        let userProfile = JSON.parse(localStorage.getItem('user_profile')) || {
            weight: 70, height: 170, age: 25, gender: 'male', goal: 'maintain'
        };

        // –¢–µ–∫—Å—Ç—ã
        const TRANSLATIONS = {
            'ru': { 
                today: '–°–µ–≥–æ–¥–Ω—è', history: '–ò—Å—Ç–æ—Ä–∏—è', add: '–î–æ–±–∞–≤–∏—Ç—å', think: '–î—É–º–∞—é...', input: '–ß—Ç–æ —Å—ä–µ–ª–∏?', empty: '–ü–æ–∫–∞ –ø—É—Å—Ç–æ', error: '–ù–µ –ø–æ–Ω—è–ª',
                profile: '–ü—Ä–æ—Ñ–∏–ª—å', home: '–ì–ª–∞–≤–Ω–∞—è', weight: '–í–µ—Å (–∫–≥)', height: '–†–æ—Å—Ç (—Å–º)', age: '–í–æ–∑—Ä–∞—Å—Ç', gender: '–ü–æ–ª', goal: '–¶–µ–ª—å',
                norm: '–í–∞—à–∞ –Ω–æ—Ä–º–∞:', vip_desc: '–ö—É–ø–∏ VIP –∏ –ø–æ–ª—É—á–∏ –±–µ–∑–ª–∏–º–∏—Ç!'
            },
            'uz': { 
                today: 'Bugun', history: 'Tarix', add: "Qo'shish", think: 'O\\'ylayapman...', input: 'Nima yediz?', empty: 'Hozircha bo\\'sh', error: 'Tushunmadim',
                profile: 'Profil', home: 'Asosiy', weight: 'Vazn (kg)', height: 'Bo\\'yi (sm)', age: 'Yosh', gender: 'Jins', goal: 'Maqsad',
                norm: 'Norma:', vip_desc: 'VIP oling va cheklovsiz ishlating!'
            },
            'en': { 
                today: 'Today', history: 'History', add: 'Add', think: 'Thinking...', input: 'What did you eat?', empty: 'Empty', error: 'Error',
                profile: 'Profile', home: 'Home', weight: 'Weight', height: 'Height', age: 'Age', gender: 'Gender', goal: 'Goal',
                norm: 'Your goal:', vip_desc: 'Get VIP for unlimited access!'
            }
        };

        function updateUITexts() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('txtToday').innerText = t.today;
            document.getElementById('txtHistory').innerText = t.history;
            document.getElementById('analyzeBtn').innerText = t.add;
            document.getElementById('foodInput').placeholder = t.input;
            if(document.getElementById('txtEmpty')) document.getElementById('txtEmpty').innerText = t.empty;
            
            document.getElementById('lblMenuHome').innerText = t.home;
            document.getElementById('lblMenuProfile').innerText = t.profile;
            document.getElementById('txtProfileTitle').innerText = t.profile;
            
            document.getElementById('lblWeight').innerText = t.weight;
            document.getElementById('lblHeight').innerText = t.height;
            document.getElementById('lblAge').innerText = t.age;
            document.getElementById('lblGender').innerText = t.gender;
            document.getElementById('lblGoal').innerText = t.goal;
            document.getElementById('lblResult').innerText = t.norm;
            document.getElementById('txtVipDesc').innerText = t.vip_desc;
        }

        function changeLanguage() {
            currentLang = document.getElementById('langSelect').value;
            localStorage.setItem('app_lang', currentLang);
            updateUITexts();
        }

        // --- –õ–û–ì–ò–ö–ê –í–ö–õ–ê–î–û–ö ---
        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            document.getElementById('tab-' + tabName).classList.add('active');
            if(tabName === 'home') document.getElementById('navHome').classList.add('active');
            if(tabName === 'profile') document.getElementById('navProfile').classList.add('active');
        }

        // --- –†–ê–°–ß–ï–¢ –ö–ê–õ–û–†–ò–ô (–ú–∏—Ñ—Ñ–ª–∏–Ω-–°–∞–Ω –ñ–µ–æ—Ä) ---
        function calculateGoal() {
            // –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            const w = parseFloat(document.getElementById('inpWeight').value) || 70;
            const h = parseFloat(document.getElementById('inpHeight').value) || 170;
            const a = parseFloat(document.getElementById('inpAge').value) || 25;
            const gender = document.getElementById('selGender').value;
            const goal = document.getElementById('selGoal').value;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            userProfile = { weight: w, height: h, age: a, gender: gender, goal: goal };
            localStorage.setItem('user_profile', JSON.stringify(userProfile));

            // –§–æ—Ä–º—É–ª–∞
            let bmr; 
            if (gender === 'male') {
                bmr = (10 * w) + (6.25 * h) - (5 * a) + 5;
            } else {
                bmr = (10 * w) + (6.25 * h) - (5 * a) - 161;
            }

            // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (—Å—Ä–µ–¥–Ω—è—è 1.375)
            let tdee = bmr * 1.375;

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ —Ü–µ–ª—å
            if (goal === 'lose') tdee -= 400; // –î–µ—Ñ–∏—Ü–∏—Ç
            if (goal === 'gain') tdee += 300; // –ü—Ä–æ—Ñ–∏—Ü–∏—Ç

            const finalGoal = Math.round(tdee);
            
            document.getElementById('calcResult').innerText = finalGoal;
            document.getElementById('targetCals').innerText = finalGoal;
            
            return finalGoal;
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        function initProfile() {
            document.getElementById('inpWeight').value = userProfile.weight;
            document.getElementById('inpHeight').value = userProfile.height;
            document.getElementById('inpAge').value = userProfile.age;
            document.getElementById('selGender').value = userProfile.gender;
            document.getElementById('selGoal').value = userProfile.goal;
            calculateGoal();
        }

        // --- –õ–û–ì–ò–ö–ê –ï–î–´ (—Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è, —Å–ª–µ–≥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è) ---
        let todayCalories = 0;
        let selectedFile = null;

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${BASE_URL}/get_history?user_id=${USER_ID}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const history = await res.json();
                
                const list = document.getElementById('foodList');
                list.innerHTML = '';
                todayCalories = 0;

                if (history.length === 0) {
                    list.innerHTML = `<li id="txtEmpty" style="text-align:center; color:grey; padding:10px">${TRANSLATIONS[currentLang].empty}</li>`;
                } else {
                    let lastDate = null;
                    const todayStr = new Date().toISOString().split('T')[0];

                    history.forEach(item => {
                        if (item.date === todayStr) todayCalories += item.calories;
                        if (item.date !== lastDate) {
                            const dateHeader = document.createElement('div');
                            dateHeader.className = 'date-header';
                            dateHeader.innerText = (item.date === todayStr) ? TRANSLATIONS[currentLang].today : item.date;
                            list.appendChild(dateHeader);
                            lastDate = item.date;
                        }
                        const li = document.createElement('li');
                        li.className = 'food-item';
                        li.innerHTML = `<span class="food-name">${item.name}</span><span class="food-calories">${item.calories}</span>`;
                        list.appendChild(li);
                    });
                }
                updateStats();
            } catch (e) {
                console.error(e);
            }
        }

        function updateStats() {
            const goal = parseInt(document.getElementById('targetCals').innerText) || 2000;
            document.getElementById('currentCals').innerText = todayCalories;
            let percent = (todayCalories / goal) * 100;
            if (percent > 100) percent = 100;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        async function processFood() {
            const textInput = document.getElementById('foodInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            const t = TRANSLATIONS[currentLang];

            if (!textInput && !selectedFile) return;

            btn.disabled = true;
            btn.innerText = t.think;

            const formData = new FormData();
            formData.append('text', textInput);
            formData.append('user_id', USER_ID);
            formData.append('language', currentLang);
            if (selectedFile) formData.append('photo', selectedFile);

            try {
                const response = await fetch(`${BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { "ngrok-skip-browser-warning": "true" },
                    body: formData
                });
                const data = await response.json();
                
                if (data.calories > 0) {
                    loadHistory();
                    document.getElementById('foodInput').value = '';
                    selectedFile = null;
                    document.getElementById('previewContainer').style.display = 'none';
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showPopup({message: t.error});
                }
            } catch (error) {
                alert("Server Error");
            } finally {
                btn.disabled = false;
                btn.innerText = t.add;
            }
        }

        // --- –õ–û–ì–ò–ö–ê VIP ---
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –∫—É–ø–∏–ª –ª–∏ —É–∂–µ —é–∑–µ—Ä VIP
        async function checkVipStatus() {
            try {
                const res = await fetch(`${BASE_URL}/check_vip?user_id=${USER_ID}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const data = await res.json();
                if (data.is_vip) {
                    document.getElementById('vipBadge').style.display = 'inline-block';
                    document.getElementById('vipCard').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏
                }
            } catch (e) { console.log("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ VIP"); }
        }

        // 2. –ü–æ–∫—É–ø–∫–∞
        async function buyVip() {
            try {
                const formData = new FormData();
                formData.append('user_id', USER_ID);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
                const response = await fetch(`${BASE_URL}/create_invoice`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.invoice_link) {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¢–µ–ª–µ–≥—Ä–∞–º-–æ–ø–ª–∞—Ç—É
                    tg.openInvoice(data.invoice_link, (status) => {
                        if (status === 'paid') {
                            tg.showAlert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —Ç–µ–ø–µ—Ä—å VIP!");
                            checkVipStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É
                        }
                    });
                }
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            }
        }

        // –ó–ê–ü–£–°–ö –ü–†–ò –°–¢–ê–†–¢–ï
        updateUITexts();
        initProfile(); // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Å—á–∏—Ç–∞–µ—Ç –Ω–æ—Ä–º—É
        loadHistory(); // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –µ–¥—ã
        checkVipStatus(); // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç VIP

    </script>
</body>
</html>
