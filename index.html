<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liquid AI Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- LIQUID GLASS STYLES --- */
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f0f13; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* –ñ–∏–≤–æ–π —Ñ–æ–Ω (–ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –ø—è—Ç–Ω–∞) */
        .background-blobs {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.6;
            animation: move 10s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #7b2cbf; animation-delay: 0s; } /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        .blob-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: #3a0ca3; animation-delay: -2s; } /* –°–∏–Ω–∏–π */
        .blob-3 { top: 40%; left: 40%; width: 200px; height: 200px; background: #f72585; opacity: 0.4; animation-duration: 15s; } /* –†–æ–∑–æ–≤—ã–π */

        @keyframes move {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -30px) scale(1.1); }
        }

        /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .glass-card {
            background: rgba(255, 255, 255, 0.07); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π */
            backdrop-filter: blur(16px); /* –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è */
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15); /* –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- –≠–õ–ï–ú–ï–ù–¢–´ --- */
        
        /* –í—ã–±–æ—Ä —è–∑—ã–∫–∞ */
        .top-bar { display: flex; justify-content: flex-end; margin-bottom: 5px; }
        .lang-select {
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            outline: none;
            font-size: 14px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-header {
            display: flex; justify-content: space-between;
            margin-bottom: 15px; font-weight: 700; font-size: 16px; letter-spacing: 0.5px;
            text-transform: uppercase; color: rgba(255,255,255,0.8);
        }
        .progress-track {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f72585, #7209b7); /* –ù–µ–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(247, 37, 133, 0.5);
        }

        /* –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ */
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 15px;
            border-radius: 15px;
            resize: none;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            transition: 0.3s;
        }
        textarea:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #f72585;
        }
        textarea::placeholder { color: rgba(255,255,255,0.4); }

        /* –ö–Ω–æ–ø–∫–∏ */
        .actions-row { display: flex; gap: 12px; margin-top: 15px; }
        
        .btn-photo {
            flex: 0 0 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            cursor: pointer; font-size: 26px;
            transition: 0.2s;
        }
        .btn-photo:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }

        .btn-send {
            flex: 1;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            transition: 0.2s;
        }
        .btn-send:active { transform: scale(0.98); opacity: 0.9; }
        .btn-send:disabled { opacity: 0.6; filter: grayscale(1); }

        /* –§–æ—Ç–æ –ø—Ä–µ–≤—å—é */
        #previewContainer { display: none; margin-bottom: 15px; border-radius: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        #previewImage { width: 100%; display: block; }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .food-list { list-style: none; padding: 0; margin: 0; }
        .date-header {
            margin-top: 20px; margin-bottom: 8px;
            font-size: 12px; color: rgba(255,255,255,0.5);
            font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            padding-left: 5px;
        }
        .food-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .food-item:last-child { border-bottom: none; }
        .food-name { font-weight: 500; font-size: 15px; }
        .food-calories {
            font-weight: 700; color: #4cc9f0;
            text-shadow: 0 0 5px rgba(76, 201, 240, 0.4);
        }
        #fileInput { display: none; }

    </style>
</head>
<body>

    <!-- –ñ–∏–≤–æ–π —Ñ–æ–Ω -->
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- –Ø–∑—ã–∫ -->
    <div class="top-bar">
        <select id="langSelect" class="lang-select" onchange="changeLanguage()">
            <option value="ru">üá∑üá∫ RU</option>
            <option value="uz">üá∫üáø UZ</option>
            <option value="en">üá∫üá∏ EN</option>
        </select>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="glass-card">
        <div class="stats-header">
            <span id="txtToday">–°–µ–≥–æ–¥–Ω—è</span>
            <span><span id="currentCals">0</span> / 2000</span>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="progressBar"></div>
        </div>
    </div>

    <!-- –í–≤–æ–¥ -->
    <div class="glass-card">
        <div id="previewContainer"><img id="previewImage" src=""></div>
        
        <textarea id="foodInput" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?"></textarea>
        
        <div class="actions-row">
            <label class="btn-photo">
                üì∑
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
            </label>
            <button class="btn-send" id="analyzeBtn" onclick="processFood()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="glass-card">
        <div class="stats-header" id="txtHistory" style="margin-bottom: 0;">–ò—Å—Ç–æ—Ä–∏—è</div>
        <ul class="food-list" id="foodList">
            <li style="text-align:center; color:rgba(255,255,255,0.4); padding:20px" id="txtEmpty">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
        </ul>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        // –í–∫–ª—é—á–∞–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
        tg.setHeaderColor('#0f0f13');
        tg.setBackgroundColor('#0f0f13');

        // üëáüëáüëá –¢–í–û–Ø –°–°–´–õ–ö–ê NGROK üëáüëáüëá
        const BASE_URL = "https://deja-embryoid-rosendo.ngrok-free.dev"; 

        const USER_ID = tg.initDataUnsafe?.user?.id || 0;
        let currentLang = localStorage.getItem('app_lang') || 'ru';
        document.getElementById('langSelect').value = currentLang;

        const TRANSLATIONS = {
            'ru': { today: '–°–µ–≥–æ–¥–Ω—è', history: '–ò—Å—Ç–æ—Ä–∏—è', add: '–ê–Ω–∞–ª–∏–∑', think: '–î—É–º–∞—é...', input: '–ù–∞–ø–∏—à–∏, —á—Ç–æ —Å—ä–µ–ª...', empty: '–ü–æ–∫–∞ –ø—É—Å—Ç–æ', error: '–ù–µ –ø–æ–Ω—è–ª' },
            'uz': { today: 'Bugun', history: 'Tarix', add: "Tahlil", think: 'O\'ylayapman...', input: 'Nima yediz?', empty: 'Hozircha bo\'sh', error: 'Tushunmadim' },
            'en': { today: 'Today', history: 'History', add: 'Analyze', think: 'Thinking...', input: 'What did you eat?', empty: 'Empty', error: 'Did not understand' }
        };

        function updateUITexts() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('txtToday').innerText = t.today;
            document.getElementById('txtHistory').innerText = t.history;
            document.getElementById('analyzeBtn').innerText = t.add;
            document.getElementById('foodInput').placeholder = t.input;
            if(document.getElementById('txtEmpty')) document.getElementById('txtEmpty').innerText = t.empty;
        }

        function changeLanguage() {
            currentLang = document.getElementById('langSelect').value;
            localStorage.setItem('app_lang', currentLang);
            updateUITexts();
        }

        let todayCalories = 0;
        const DAILY_GOAL = 2000;
        let selectedFile = null;

        async function loadHistory() {
            try {
                const res = await fetch(`${BASE_URL}/get_history?user_id=${USER_ID}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const history = await res.json();
                
                const list = document.getElementById('foodList');
                list.innerHTML = '';
                todayCalories = 0;

                if (history.length === 0) {
                    list.innerHTML = `<li id="txtEmpty" style="text-align:center; color:rgba(255,255,255,0.4); padding:20px">${TRANSLATIONS[currentLang].empty}</li>`;
                    return;
                }

                let lastDate = null;
                const todayStr = new Date().toISOString().split('T')[0];

                history.forEach(item => {
                    if (item.date === todayStr) {
                        todayCalories += item.calories;
                    }
                    if (item.date !== lastDate) {
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'date-header';
                        dateHeader.innerText = (item.date === todayStr) ? TRANSLATIONS[currentLang].today : item.date;
                        list.appendChild(dateHeader);
                        lastDate = item.date;
                    }
                    const li = document.createElement('li');
                    li.className = 'food-item';
                    li.innerHTML = `<span class="food-name">${item.name}</span><span class="food-calories">${item.calories}</span>`;
                    list.appendChild(li);
                });
                updateStats();
            } catch (e) { console.error(e); }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        async function processFood() {
            const textInput = document.getElementById('foodInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            const t = TRANSLATIONS[currentLang];

            if (!textInput && !selectedFile) return;

            btn.disabled = true;
            btn.innerText = t.think;

            const formData = new FormData();
            formData.append('text', textInput);
            formData.append('user_id', USER_ID);
            formData.append('language', currentLang);
            if (selectedFile) formData.append('photo', selectedFile);

            try {
                const response = await fetch(`${BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { "ngrok-skip-browser-warning": "true" },
                    body: formData
                });
                const data = await response.json();

                if (data.calories > 0) {
                    loadHistory();
                    document.getElementById('foodInput').value = '';
                    selectedFile = null;
                    document.getElementById('previewContainer').style.display = 'none';
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showPopup({message: t.error});
                }
            } catch (error) {
                alert("Server Error");
            } finally {
                btn.disabled = false;
                btn.innerText = t.add;
            }
        }

        function updateStats() {
            document.getElementById('currentCals').innerText = todayCalories;
            let percent = (todayCalories / DAILY_GOAL) * 100;
            if (percent > 100) percent = 100;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        updateUITexts();
        loadHistory();
    </script>
</body>
</html>
