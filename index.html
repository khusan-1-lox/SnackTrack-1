<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Nutrition Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg-color: #000; --card-bg: rgba(30, 30, 30, 0.7); --border-color: rgba(255, 255, 255, 0.15); --text-color: #f0f0f0; --accent-blue: #0A84FF; }
        body { margin: 0; padding: 16px; font-family: -apple-system, sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 10% 20%, #0A84FF 0%, transparent 30%), radial-gradient(circle at 90% 80%, #FF2D55 0%, transparent 30%); }
        .glass-card { background: var(--card-bg); backdrop-filter: blur(25px); border: 1px solid var(--border-color); border-radius: 24px; padding: 20px; }
        textarea { width: 100%; background: transparent; border: none; color: var(--text-color); padding: 15px 0; font-size: 18px; resize: none; outline: none; }
        .btn-main { width: 100%; margin-top: 15px; background: var(--accent-blue); color: white; border: none; border-radius: 16px; height: 55px; font-weight: 600; font-size: 18px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ */
        #subscription-view { text-align: center; padding-top: 30vh; }
        #main-app-view { display: none; flex-direction: column; gap: 16px; }
    </style>
</head>
<body>
    <!-- 1. –≠–ö–†–ê–ù –ü–û–î–ü–ò–°–ö–ò (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="subscription-view">
        <h1>PRO –î–æ—Å—Ç—É–ø</h1>
        <p style="color:#888;">–ü–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º, –≤–∫–ª—é—á–∞—è –∞–Ω–∞–ª–∏–∑ –ò–ò.</p>
        <button class="btn-main" onclick="subscribe()">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è (–¢–µ—Å—Ç)</button>
    </div>

    <!-- 2. –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (—Å–∫—Ä—ã—Ç–æ) -->
    <div id="main-app-view">
        <div style="display:flex; justify-content:flex-end;"><button onclick="openProfile()" style="background:transparent;border:none;color:#fff;font-size:24px;">‚öôÔ∏è</button></div>
        <div class="glass-card">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        </div>
        <div class="glass-card">
            <textarea id="foodInput" rows="2" placeholder="–°—ä–µ–ª 2 —è–π—Ü–∞ –∏ —Ç–æ—Å—Ç..."></textarea>
            <button class="btn-main" id="analyzeBtn" onclick="processFood()">–ê–Ω–∞–ª–∏–∑</button>
        </div>
        <div class="glass-card">
            <div style="font-weight:600; color:#888; margin-bottom:10px;">–ò—Å—Ç–æ—Ä–∏—è</div>
            <ul id="foodList" style="list-style:none; padding:0; margin:0;"></ul>
        </div>
    </div>
    
    <!-- (–ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è - –µ–µ HTML –∑–¥–µ—Å—å –Ω–µ –ø–æ–∫–∞–∑–∞–Ω, –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å) -->

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000');

        // üëá –°–°–´–õ–ö–ê NGROK
        const BASE_URL = " https://deja-embryoid-rosendo.ngrok-free.dev";
        const USER_ID = tg.initDataUnsafe?.user?.id || 1;

        // 1. –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò –ü–†–ò –ó–ê–ü–£–°–ö–ï
        async function checkSubscription() {
            try {
                const res = await fetch(`${BASE_URL}/check_status?user_id=${USER_ID}`, { headers: {"ngrok-skip-browser-warning":"true"} });
                const data = await res.json();
                if (data.is_pro) {
                    document.getElementById('subscription-view').style.display = 'none';
                    document.getElementById('main-app-view').style.display = 'flex';
                    // loadData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –∏—Å—Ç–æ—Ä–∏—é
                }
            } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞'); }
        }

        // 2. "–ü–û–ö–£–ü–ö–ê" –ü–û–î–ü–ò–°–ö–ò
        async function subscribe() {
            const formData = new FormData();
            formData.append('user_id', USER_ID);
            try {
                await fetch(`${BASE_URL}/subscribe`, { method: 'POST', body: formData, headers: {"ngrok-skip-browser-warning":"true"} });
                await checkSubscription(); // –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏'); }
        }

        // 3. –ê–ù–ê–õ–ò–ó –ï–î–´
        async function processFood() {
            const text = document.getElementById('foodInput').value;
            if (!text) return;
            // ... (–∑–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –≤—ã–∑–æ–≤–∞ /analyze –∏ /save_meal)
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        checkSubscription();
    </script>
</body>
</html>
