<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calorie AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* (–°—Ç–∏–ª–∏ —Ç–µ –∂–µ, –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–≤–∏–ª –±–∞–∑–æ–≤—ã–µ) */
        :root { --bg-color: #fff; --text-color: #000; --btn-color: #3390ec; --gray-bg: #f4f4f5; }
        body { background-color: var(--gray-bg); color: var(--text-color); font-family: Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 80px; }
        .card { background: var(--bg-color); margin: 10px 15px; padding: 15px; border-radius: 12px; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
        .progress-track { width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--btn-color); width: 0%; transition: width 0.3s; }
        textarea { width: 100%; height: 60px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; resize: none; }
        .btn { border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: var(--btn-color); color: #fff; width:100%; margin-top:10px;}
        .bottom-menu { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 999; }
        .menu-btn { flex: 1; text-align: center; color: #999; cursor: pointer; }
        .menu-btn.active { color: var(--btn-color); }
        .screen { display: none; }
        .screen.active { display: block; }
        .input-group { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .input-group input, .input-group select { width: 100px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; text-align: center; }
        .vip-active-badge { display: none; background: gold; color: #000; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .btn-gold { background: gold; color: #000; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–ê–Ø -->
    <div id="screen-home" class="screen active">
        <div class="card">
            <div class="stats-row">
                <span>–°–µ–≥–æ–¥–Ω—è</span>
                <span><span id="valCurrent">0</span> / <span id="valGoal">2000</span></span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
        </div>
        <div class="card">
            <textarea id="foodInput" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏?"></textarea>
            <input type="file" id="fileInput" accept="image/*" style="margin-top:10px">
            <button class="btn" id="btnAnalyze" onclick="analyzeFood()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="card" id="historyList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ü–†–û–§–ò–õ–¨ -->
    <div id="screen-profile" class="screen">
        <div class="card">
            <div class="stats-row">–ü—Ä–æ—Ñ–∏–ª—å <span id="vipBadge" class="vip-active-badge">üëë VIP</span></div>
            
            <div class="input-group"><label>–í–µ—Å (–∫–≥)</label><input type="number" id="inpWeight" onchange="saveProfile()"></div>
            <div class="input-group"><label>–†–æ—Å—Ç (—Å–º)</label><input type="number" id="inpHeight" onchange="saveProfile()"></div>
            <div class="input-group"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input type="number" id="inpAge" onchange="saveProfile()"></div>
            <div class="input-group"><label>–ü–æ–ª</label>
                <select id="inpGender" onchange="saveProfile()">
                    <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
            </div>
            <div class="input-group"><label>–¶–µ–ª—å</label>
                <select id="inpGoal" onchange="saveProfile()">
                    <option value="lose">–ü–æ—Ö—É–¥–µ—Ç—å</option>
                    <option value="maintain">–î–µ—Ä–∂–∞—Ç—å</option>
                    <option value="gain">–ù–∞–±—Ä–∞—Ç—å</option>
                </select>
            </div>
            <div style="text-align:center; margin-top:10px;">–ù–æ—Ä–º–∞: <b id="lblCalcGoal">2000</b></div>
        </div>

        <div class="card" id="vipPromo">
            <h3>üåü VIP –°—Ç–∞—Ç—É—Å</h3>
            <button class="btn btn-gold" onclick="buyVip()">–ö—É–ø–∏—Ç—å –∑–∞ 50 ‚≠êÔ∏è</button>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="bottom-menu">
        <div class="menu-btn active" id="tabHome" onclick="openScreen('home')">üè† –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="menu-btn" id="tabProfile" onclick="openScreen('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        // üëáüëáüëá –í–°–¢–ê–í–¨ URL NGROK üëáüëáüëá
        const BASE_URL = "https://deja-embryoid-rosendo.ngrok-free.dev"; 
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        const USER_ID = tg.initDataUnsafe?.user?.id || 11111;

        let dailyGoal = 2000;
        let todayCalories = 0;

        function openScreen(name) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
            if(name === 'home') document.getElementById('tabHome').classList.add('active');
            if(name === 'profile') document.getElementById('tabProfile').classList.add('active');
        }

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–ì–û ---
        async function initApp() {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞
                const res = await fetch(`${BASE_URL}/get_profile?user_id=${USER_ID}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const data = await res.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                document.getElementById('inpWeight').value = data.weight;
                document.getElementById('inpHeight').value = data.height;
                document.getElementById('inpAge').value = data.age;
                document.getElementById('inpGender').value = data.gender;
                document.getElementById('inpGoal').value = data.goal;

                // –ï—Å–ª–∏ VIP
                if (data.is_vip) {
                    document.getElementById('vipPromo').style.display = 'none';
                    document.getElementById('vipBadge').style.display = 'inline-block';
                }

                // –°—á–∏—Ç–∞–µ–º –Ω–æ—Ä–º—É
                calculateLocalGoal();
                
                // –ì—Ä—É–∑–∏–º –∏—Å—Ç–æ—Ä–∏—é
                loadHistory();

            } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e); }
        }

        // –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        function calculateLocalGoal() {
            const w = parseFloat(document.getElementById('inpWeight').value);
            const h = parseFloat(document.getElementById('inpHeight').value);
            const a = parseFloat(document.getElementById('inpAge').value);
            const gender = document.getElementById('inpGender').value;
            const goal = document.getElementById('inpGoal').value;

            let bmr = (gender === 'male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
            let result = Math.round(bmr * 1.375);
            if (goal === 'lose') result -= 400;
            if (goal === 'gain') result += 300;

            dailyGoal = result;
            document.getElementById('valGoal').innerText = dailyGoal;
            document.getElementById('lblCalcGoal').innerText = dailyGoal;
            updateProgress();
        }

        // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê –°–ï–†–í–ï–† ---
        async function saveProfile() {
            calculateLocalGoal(); // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ

            const formData = new FormData();
            formData.append('user_id', USER_ID);
            formData.append('weight', document.getElementById('inpWeight').value);
            formData.append('height', document.getElementById('inpHeight').value);
            formData.append('age', document.getElementById('inpAge').value);
            formData.append('gender', document.getElementById('inpGender').value);
            formData.append('goal', document.getElementById('inpGoal').value);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–∏—Ö–æ, –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            await fetch(`${BASE_URL}/save_profile`, { method: 'POST', body: formData });
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            const res = await fetch(`${BASE_URL}/get_history?user_id=${USER_ID}`, {
                headers: { "ngrok-skip-browser-warning": "true" }
            });
            const data = await res.json();
            
            list.innerHTML = "";
            todayCalories = 0;
            
            if (data.length === 0) list.innerHTML = "–ü—É—Å—Ç–æ";
            
            const todayStr = new Date().toISOString().split('T')[0];
            data.forEach(item => {
                if (item.date === todayStr) todayCalories += item.calories;
                const div = document.createElement('div');
                div.innerHTML = `<b>${item.name}</b>: ${item.calories}`;
                div.style.borderBottom = "1px solid #eee";
                div.style.padding = "5px 0";
                list.appendChild(div);
            });
            updateProgress();
        }

        function updateProgress() {
            document.getElementById('valCurrent').innerText = todayCalories;
            let p = (todayCalories / dailyGoal) * 100;
            if (p > 100) p = 100;
            document.getElementById('progressBar').style.width = p + "%";
        }

        async function analyzeFood() {
            const txt = document.getElementById('foodInput').value;
            const file = document.getElementById('fileInput').files[0];
            const btn = document.getElementById('btnAnalyze');

            if (!txt && !file) return;
            btn.innerText = "–°—á–∏—Ç–∞—é..."; btn.disabled = true;

            const fd = new FormData();
            fd.append('user_id', USER_ID);
            fd.append('text', txt);
            if (file) fd.append('photo', file);

            try {
                const res = await fetch(`${BASE_URL}/analyze`, { method: 'POST', body: fd });
                const d = await res.json();
                if (d.calories > 0) {
                    tg.showAlert(`‚úÖ ${d.name}: ${d.calories}`);
                    document.getElementById('foodInput').value = "";
                    loadHistory();
                } else {
                    tg.showAlert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            btn.innerText = "–î–æ–±–∞–≤–∏—Ç—å"; btn.disabled = false;
        }

        async function buyVip() {
            const fd = new FormData();
            fd.append('user_id', USER_ID);
            const res = await fetch(`${BASE_URL}/create_invoice`, { method: 'POST', body: fd });
            const d = await res.json();
            if (d.invoice_link) tg.openInvoice(d.invoice_link, (s) => { if(s==='paid') initApp(); });
        }

        // –ó–∞–ø—É—Å–∫
        initApp();

    </script>
</body>
</html>
